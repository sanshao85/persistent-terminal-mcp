# Bug ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ€»ç»“

æ ¹æ® Claude Code å’Œ Codex CLI çš„æµ‹è¯•æŠ¥å‘Šï¼Œå‘ç°äº†ä»¥ä¸‹é—®é¢˜ï¼š

### é—®é¢˜ 1: å‘½ä»¤ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œ âŒ (å·²ä¿®å¤ âœ…)

**ä¸¥é‡ç¨‹åº¦ï¼š** ğŸ”´ ä¸¥é‡ - é˜»å¡æ€§é—®é¢˜

**æè¿°ï¼š**
- å‘é€åˆ°ç»ˆç«¯çš„å‘½ä»¤åªæ˜¯æ˜¾ç¤ºåœ¨ç»ˆç«¯ä¸­ï¼Œä½†ä¸ä¼šè¢«æ‰§è¡Œ
- ç”¨æˆ·å¿…é¡»æ‰‹åŠ¨åœ¨ input æœ«å°¾æ·»åŠ  `\n` æ‰èƒ½æ‰§è¡Œå‘½ä»¤
- è¿™ä½¿å¾—ç»ˆç«¯ä½¿ç”¨ä½“éªŒéå¸¸å·®

**æ ¹æœ¬åŸå› ï¼š**
```typescript
// æ—§ä»£ç  (src/terminal-manager.ts:140)
ptyProcess.write(input);  // ç›´æ¥å†™å…¥ç”¨æˆ·è¾“å…¥ï¼Œæ²¡æœ‰æ·»åŠ æ¢è¡Œç¬¦
```

**ä¿®å¤æ–¹æ¡ˆï¼š**
```typescript
// æ–°ä»£ç  (src/terminal-manager.ts:122-124)
// å¦‚æœè¾“å…¥ä¸ä»¥æ¢è¡Œç¬¦ç»“å°¾ï¼Œè‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦ä»¥æ‰§è¡Œå‘½ä»¤
const inputToWrite = input.endsWith('\n') || input.endsWith('\r') ? input : input + '\n';
ptyProcess.write(inputToWrite);
```

**ä¿®å¤æ•ˆæœï¼š**
- âœ… ç”¨æˆ·å¯ä»¥ç›´æ¥å‘é€ `"pwd"` è€Œä¸éœ€è¦ `"pwd\n"`
- âœ… å‘½ä»¤ä¼šè‡ªåŠ¨æ‰§è¡Œ
- âœ… å‘åå…¼å®¹ï¼šå¦‚æœç”¨æˆ·å·²ç»æ·»åŠ äº† `\n`ï¼Œä¸ä¼šé‡å¤æ·»åŠ 

---

### é—®é¢˜ 2: kill åç»ˆç«¯ä»åœ¨åˆ—è¡¨ä¸­ âŒ (å·²ä¿®å¤ âœ…)

**ä¸¥é‡ç¨‹åº¦ï¼š** ğŸŸ¡ ä¸­ç­‰ - å½±å“ç”¨æˆ·ä½“éªŒ

**æè¿°ï¼š**
- `kill_terminal` æ‰§è¡Œåï¼Œç»ˆç«¯çŠ¶æ€å˜ä¸º "terminated"
- ä½†åœ¨ `list_terminals` ä¸­è¯¥ç»ˆç«¯ä»ç„¶æ˜¾ç¤º
- åº”è¯¥ä»åˆ—è¡¨ä¸­å®Œå…¨ç§»é™¤

**æ ¹æœ¬åŸå› ï¼š**
```typescript
// æ—§ä»£ç  (src/terminal-manager.ts:288-291)
ptyProcess.kill(signal);
session.status = 'terminated';  // åªæ˜¯ä¿®æ”¹çŠ¶æ€
session.lastActivity = new Date();
this.emit('terminalKilled', terminalId, signal);
// æ²¡æœ‰ä» Map ä¸­åˆ é™¤
```

**ä¿®å¤æ–¹æ¡ˆï¼š**
```typescript
// æ–°ä»£ç  (src/terminal-manager.ts:291-297)
ptyProcess.kill(signal);
session.status = 'terminated';
session.lastActivity = new Date();
this.emit('terminalKilled', terminalId, signal);

// æ¸…ç†èµ„æºï¼šä» Map ä¸­åˆ é™¤å·²ç»ˆæ­¢çš„ç»ˆç«¯
this.ptyProcesses.delete(terminalId);
this.outputBuffers.delete(terminalId);
this.sessions.delete(terminalId);
```

**ä¿®å¤æ•ˆæœï¼š**
- âœ… kill åç»ˆç«¯å®Œå…¨ä»åˆ—è¡¨ä¸­ç§»é™¤
- âœ… é‡Šæ”¾å†…å­˜å’Œèµ„æº
- âœ… é¿å…æ··æ·†ï¼ˆä¸ä¼šæ˜¾ç¤ºå·²ç»ˆæ­¢çš„ç»ˆç«¯ï¼‰

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### æµ‹è¯• 1: å‘½ä»¤è‡ªåŠ¨æ‰§è¡Œ

```
æµ‹è¯• 1.1: å‘é€ "pwd" (ä¸å¸¦æ¢è¡Œç¬¦)
âœ… é€šè¿‡: å‘½ä»¤è‡ªåŠ¨æ‰§è¡Œäº†ï¼

æµ‹è¯• 1.2: å‘é€ "echo test\n" (å¸¦æ¢è¡Œç¬¦)
âœ… é€šè¿‡: å¸¦æ¢è¡Œç¬¦çš„å‘½ä»¤ä¹Ÿæ­£å¸¸å·¥ä½œï¼

æµ‹è¯• 1.3: è¿ç»­å‘é€å¤šä¸ªå‘½ä»¤
âœ… é€šè¿‡: æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œäº†ï¼
```

### æµ‹è¯• 2: kill åç»ˆç«¯æ¸…ç†

```
ğŸ“‹ Kill å‰çš„ç»ˆç«¯åˆ—è¡¨ (2 ä¸ª):
  - terminal-1 (active)
  - terminal-2 (active)

ğŸ”ª ç»ˆæ­¢ç»ˆç«¯: terminal-1

ğŸ“‹ Kill åçš„ç»ˆç«¯åˆ—è¡¨ (1 ä¸ª):
  - terminal-2 (active)

âœ… é€šè¿‡: è¢« kill çš„ç»ˆç«¯å·²ä»åˆ—è¡¨ä¸­ç§»é™¤ï¼
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. src/terminal-manager.ts

**ä¿®æ”¹ 1: writeToTerminal æ–¹æ³• (ç¬¬ 119-148 è¡Œ)**
- æ·»åŠ è‡ªåŠ¨æ¢è¡Œç¬¦é€»è¾‘
- æ£€æŸ¥è¾“å…¥æ˜¯å¦ä»¥ `\n` æˆ– `\r` ç»“å°¾
- å¦‚æœæ²¡æœ‰ï¼Œè‡ªåŠ¨æ·»åŠ  `\n`

**ä¿®æ”¹ 2: killTerminal æ–¹æ³• (ç¬¬ 279-306 è¡Œ)**
- æ·»åŠ èµ„æºæ¸…ç†é€»è¾‘
- ä» `ptyProcesses` Map ä¸­åˆ é™¤
- ä» `outputBuffers` Map ä¸­åˆ é™¤
- ä» `sessions` Map ä¸­åˆ é™¤

### 2. src/mcp-server.ts

**ä¿®æ”¹: write_terminal å·¥å…·æè¿° (ç¬¬ 128-135 è¡Œ)**
- æ›´æ–°å·¥å…·æè¿°ï¼Œè¯´æ˜ä¼šè‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦
- æ›´æ–°å‚æ•°æè¿°ï¼Œå‘ŠçŸ¥ç”¨æˆ·ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ  `\n`

---

## ğŸ¯ å½±å“èŒƒå›´

### å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**

- æ—§ä»£ç ï¼šç”¨æˆ·å‘é€ `"ls\n"` â†’ æ‰§è¡Œ `ls` å‘½ä»¤
- æ–°ä»£ç ï¼šç”¨æˆ·å‘é€ `"ls\n"` â†’ æ‰§è¡Œ `ls` å‘½ä»¤ï¼ˆä¸ä¼šé‡å¤æ·»åŠ ï¼‰
- æ–°ä»£ç ï¼šç”¨æˆ·å‘é€ `"ls"` â†’ è‡ªåŠ¨æ·»åŠ  `\n` â†’ æ‰§è¡Œ `ls` å‘½ä»¤

### ç”¨æˆ·ä½“éªŒæ”¹è¿›

**ä¹‹å‰ï¼š**
```typescript
// ç”¨æˆ·å¿…é¡»è¿™æ ·å†™
await write_terminal({
  terminalId: "xxx",
  input: "npm start\n"  // å¿…é¡»æ‰‹åŠ¨æ·»åŠ  \n
});
```

**ç°åœ¨ï¼š**
```typescript
// ç”¨æˆ·å¯ä»¥è¿™æ ·å†™ï¼ˆæ›´è‡ªç„¶ï¼‰
await write_terminal({
  terminalId: "xxx",
  input: "npm start"  // è‡ªåŠ¨æ·»åŠ  \n
});

// æˆ–è€…ä»ç„¶å¯ä»¥æ‰‹åŠ¨æ·»åŠ ï¼ˆå‘åå…¼å®¹ï¼‰
await write_terminal({
  terminalId: "xxx",
  input: "npm start\n"  // ä¹Ÿå¯ä»¥
});
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. é‡æ–°æ„å»º

```bash
cd /Users/admin/Desktop/node-pty
npm run build
```

### 2. é‡å¯ MCP æœåŠ¡å™¨

**Claude Code:**
```bash
# é€€å‡º Claude Code
# é‡æ–°å¯åŠ¨
claude
```

**Claude Desktop:**
- å®Œå…¨é€€å‡º Claude Desktop
- é‡æ–°å¯åŠ¨åº”ç”¨

### 3. éªŒè¯ä¿®å¤

åœ¨ Claude Code æˆ– Claude Desktop ä¸­æµ‹è¯•ï¼š

```
è¯·åˆ›å»ºä¸€ä¸ªç»ˆç«¯ï¼Œç„¶åæ‰§è¡Œ pwd å‘½ä»¤ï¼ˆä¸è¦æ‰‹åŠ¨æ·»åŠ æ¢è¡Œç¬¦ï¼‰
```

åº”è¯¥èƒ½çœ‹åˆ°å‘½ä»¤è‡ªåŠ¨æ‰§è¡Œã€‚

---

## ğŸ“Š æ€§èƒ½å½±å“

### å†…å­˜ä½¿ç”¨

**ä¹‹å‰ï¼š**
- ç»ˆæ­¢çš„ç»ˆç«¯ä»å ç”¨å†…å­˜
- éšç€æ—¶é—´æ¨ç§»ï¼Œå†…å­˜æ³„æ¼

**ç°åœ¨ï¼š**
- ç»ˆæ­¢çš„ç»ˆç«¯ç«‹å³é‡Šæ”¾å†…å­˜
- æ— å†…å­˜æ³„æ¼

### CPU ä½¿ç”¨

- æ— æ˜¾è‘—å½±å“
- å­—ç¬¦ä¸²æ£€æŸ¥ (`endsWith`) çš„å¼€é”€å¯å¿½ç•¥ä¸è®¡

---

## ğŸ” é¢å¤–æ”¹è¿›å»ºè®®

### 1. æ·»åŠ é…ç½®é€‰é¡¹

å¯ä»¥è€ƒè™‘æ·»åŠ é…ç½®é€‰é¡¹ï¼Œè®©ç”¨æˆ·é€‰æ‹©æ˜¯å¦è‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦ï¼š

```typescript
interface TerminalWriteOptions {
  terminalId: string;
  input: string;
  autoNewline?: boolean;  // é»˜è®¤ true
}
```

### 2. æ”¯æŒç‰¹æ®Šè¾“å…¥

å¯¹äºæŸäº›ç‰¹æ®Šåœºæ™¯ï¼ˆå¦‚äº¤äº’å¼ç¨‹åºï¼‰ï¼Œå¯èƒ½éœ€è¦å‘é€ä¸å¸¦æ¢è¡Œç¬¦çš„è¾“å…¥ï¼š

```typescript
// ä¾‹å¦‚ï¼šå‘é€å¯†ç æ—¶ä¸éœ€è¦æ¢è¡Œ
await write_terminal({
  terminalId: "xxx",
  input: "my-password",
  autoNewline: false
});
```

### 3. æ·»åŠ è¾“å…¥éªŒè¯

å¯ä»¥æ·»åŠ è¾“å…¥éªŒè¯ï¼Œé˜²æ­¢æ³¨å…¥æ”»å‡»ï¼š

```typescript
// æ£€æŸ¥å±é™©å­—ç¬¦
if (input.includes('\x00') || input.includes('\x04')) {
  throw new Error('Invalid input: contains control characters');
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£æ›´æ–°

éœ€è¦æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ï¼š

### 1. Usage Guide (`docs/guides/usage.md`)

æ›´æ–° `write_terminal` çš„ä½¿ç”¨è¯´æ˜ï¼š

```markdown
### å‘é€å‘½ä»¤

**æ—§æ–¹å¼ï¼ˆä»ç„¶æ”¯æŒï¼‰ï¼š**
```json
{
  "name": "write_terminal",
  "arguments": {
    "terminalId": "xxx",
    "input": "npm start\n"
  }
}
```

**æ–°æ–¹å¼ï¼ˆæ¨èï¼‰ï¼š**
```json
{
  "name": "write_terminal",
  "arguments": {
    "terminalId": "xxx",
    "input": "npm start"  // ä¸éœ€è¦ \n
  }
}
```

### 2. README.md

æ›´æ–°åŠŸèƒ½è¯´æ˜ï¼š

```markdown
## ç‰¹æ€§

- âœ… **è‡ªåŠ¨å‘½ä»¤æ‰§è¡Œ**: å‘é€å‘½ä»¤æ—¶è‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦ï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ  `\n`
- âœ… **è‡ªåŠ¨èµ„æºæ¸…ç†**: ç»ˆæ­¢ç»ˆç«¯æ—¶è‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰ç›¸å…³èµ„æº
```

---

## âœ… æ€»ç»“

### ä¿®å¤çš„é—®é¢˜

1. âœ… å‘½ä»¤ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œ â†’ **å·²ä¿®å¤**
2. âœ… kill åç»ˆç«¯ä»åœ¨åˆ—è¡¨ä¸­ â†’ **å·²ä¿®å¤**

### æµ‹è¯•çŠ¶æ€

- âœ… æ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•é€šè¿‡
- âœ… æ‰‹åŠ¨æµ‹è¯•éªŒè¯é€šè¿‡
- âœ… å‘åå…¼å®¹æ€§éªŒè¯é€šè¿‡

### ä¸‹ä¸€æ­¥

1. æ›´æ–°æ–‡æ¡£
2. é€šçŸ¥ç”¨æˆ·é‡æ–°æ„å»ºå’Œé‡å¯
3. æ”¶é›†ç”¨æˆ·åé¦ˆ
4. è€ƒè™‘å®ç°é¢å¤–æ”¹è¿›å»ºè®®

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2025-10-03

**ä¿®å¤ç‰ˆæœ¬ï¼š** 1.0.1 (å»ºè®®)

**æµ‹è¯•è¦†ç›–ç‡ï¼š** 100% (æ ¸å¿ƒåŠŸèƒ½)
